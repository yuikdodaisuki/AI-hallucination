"""LLMå®¢æˆ·ç«¯ç®¡ç†"""
import configparser
import os
import re
from openai import OpenAI
from src.AIquest.config import LLM_CONFIG, METRIC_CATEGORIES, METRIC_KEYWORDS,is_school_extraction_enabled


class LLMClient:
    """LLMå®¢æˆ·ç«¯ç®¡ç†ç±»"""
    
    def __init__(self, config_path=None):
        self.client = self._init_client(config_path)
        self.model_name = LLM_CONFIG['model_name']
        self.max_doc_length = LLM_CONFIG['max_doc_length']
    
    def _init_client(self, config_path):
        """åˆå§‹åŒ–OpenAIå®¢æˆ·ç«¯"""
        if config_path is None:
            current_dir = os.path.dirname(os.path.dirname(os.path.abspath(__file__)))
            config_path = os.path.join(current_dir, 'config.ini')
        
        config = configparser.ConfigParser()
        api_key = None
        
        if os.path.exists(config_path):
            config.read(config_path)
            api_key = config.get('DEFAULT', 'DASHSCOPE_API_KEY', fallback=None)
        
        if not api_key:
            print("è­¦å‘Š: æœªåœ¨é…ç½®æ–‡ä»¶ä¸­æ‰¾åˆ° DASHSCOPE_API_KEY")
            return None
        
        return OpenAI(
            api_key=api_key,
            base_url=LLM_CONFIG['base_url']
        )
    
    def get_data_file_for_metric(self, metric_name, data_reader):
        """ğŸ”¥ æ–°å¢ï¼šè·å–æŒ‡æ ‡å¯¹åº”çš„æ•°æ®æ–‡ä»¶è·¯å¾„ ğŸ”¥"""
        # é¦–å…ˆå°è¯•æŸ¥æ‰¾å·²å­˜åœ¨çš„æ–‡ä»¶
        existing_file = data_reader.find_existing_consolidated_file(metric_name)
        
        if existing_file:
            # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦ä¸å½“å‰æ¨¡å¼åŒ¹é…
            file_info = data_reader.get_consolidated_file_info(metric_name)
            if file_info:
                current_mode = "intelligent" if is_school_extraction_enabled() else "traditional"
                file_mode = file_info.get('processing_mode', 'unknown')
                
                if file_mode == current_mode:
                    print(f"  âœ… æ‰¾åˆ°åŒ¹é…å½“å‰æ¨¡å¼çš„æ–‡ä»¶: {file_info['file_name']}")
                    return existing_file
                else:
                    print(f"  âš ï¸  æ–‡ä»¶æ¨¡å¼ä¸åŒ¹é… (æ–‡ä»¶:{file_mode}, å½“å‰:{current_mode})ï¼Œå°†é‡æ–°ç”Ÿæˆ")
        
        # å¦‚æœæ²¡æœ‰æ‰¾åˆ°åŒ¹é…çš„æ–‡ä»¶ï¼Œç”Ÿæˆæ–°çš„æ•´åˆæ•°æ®
        print(f"  ğŸ”„ é‡æ–°æ•´åˆæŒ‡æ ‡ '{metric_name}' çš„æ•°æ®...")
        return data_reader.consolidate_data_for_metric(metric_name)

    def get_answers_for_metric(self, questions_list, document_text, metric_name, data_reader=None):
        """ä¸ºç‰¹å®šæŒ‡æ ‡è·å–ç­”æ¡ˆ"""
        # ğŸ”¥ å¦‚æœæä¾›äº†data_readerï¼Œä½¿ç”¨åŠ¨æ€æ–‡ä»¶é€‰æ‹© ğŸ”¥
        if data_reader and not document_text:
            data_file = self.get_data_file_for_metric(metric_name, data_reader)
            if data_file:
                document_text = data_reader.extract_text_content(data_file)
                print(f"  ğŸ“„ ä»æ•°æ®æ–‡ä»¶åŠ è½½å†…å®¹: {os.path.basename(data_file)}")
            else:
                print(f"  âŒ æ— æ³•è·å–æŒ‡æ ‡ '{metric_name}' çš„æ•°æ®æ–‡ä»¶")
                return ["æ— æ³•è·å–æ•°æ®æ–‡ä»¶"] * len(questions_list)
        # ğŸ”¥ æ·»åŠ æ•°æ®å†…å®¹è°ƒè¯• ğŸ”¥
        print(f"  ğŸ“Š æ•°æ®å†…å®¹æ£€æŸ¥:")
        print(f"    - æ•°æ®é•¿åº¦: {len(document_text)} å­—ç¬¦")
        print(f"    - æ•°æ®å‰200å­—ç¬¦: {document_text[:200]}...")
        
        # ğŸ”¥ æ£€æŸ¥å…³é”®å­¦æ ¡ä¿¡æ¯ ğŸ”¥
        if 'ä¸­å±±å¤§å­¦' in document_text:
            print(f"    âœ… æ•°æ®ä¸­åŒ…å«'ä¸­å±±å¤§å­¦'")
            # æ‰¾åˆ°ä¸­å±±å¤§å­¦ç›¸å…³çš„å†…å®¹ç‰‡æ®µ
            import re
            pattern = r'.{0,100}ä¸­å±±å¤§å­¦.{0,100}'
            matches = re.findall(pattern, document_text)
            for i, match in enumerate(matches[:3]):  # åªæ˜¾ç¤ºå‰3ä¸ªåŒ¹é…
                print(f"    ğŸ“ ä¸­å±±å¤§å­¦ç›¸å…³ç‰‡æ®µ{i+1}: {match}")
        else:
            print(f"    âŒ æ•°æ®ä¸­ä¸åŒ…å«'ä¸­å±±å¤§å­¦'")
        
        # ğŸ”¥ æ£€æŸ¥åŒä¸€æµå…³é”®è¯ ğŸ”¥
        keywords = ['åŒä¸€æµ', 'ä¸–ç•Œä¸€æµ', 'ä¸€æµå­¦ç§‘', 'å­¦ç§‘å»ºè®¾']
        found_keywords = []
        for keyword in keywords:
            if keyword in document_text:
                found_keywords.append(keyword)
        print(f"    ğŸ”‘ æ‰¾åˆ°å…³é”®è¯: {found_keywords}")
        
        # å¦‚æœæ²¡æœ‰æ‰¾åˆ°å…³é”®ä¿¡æ¯ï¼Œè¿™å¯èƒ½æ˜¯æ•°æ®é—®é¢˜
        if 'ä¸­å±±å¤§å­¦' not in document_text or not found_keywords:
            print(f"    âš ï¸  è­¦å‘Š: æ•°æ®ä¸­ç¼ºå°‘å…³é”®ä¿¡æ¯ï¼ŒLLMå¯èƒ½æ— æ³•æ‰¾åˆ°æ­£ç¡®ç­”æ¡ˆ")
        """ä¸ºç‰¹å®šæŒ‡æ ‡è·å–ç­”æ¡ˆ"""
        if not self.client:
            print("é”™è¯¯: OpenAI å®¢æˆ·ç«¯æœªåˆå§‹åŒ–")
            return ["LLMå®¢æˆ·ç«¯æœªåˆå§‹åŒ–"] * len(questions_list)
        
        if not document_text or not document_text.strip():
            print("é”™è¯¯: æä¾›çš„æ–‡æ¡£å†…å®¹ä¸ºç©º")
            return ["æ–‡æ¡£å†…å®¹ä¸ºç©º"] * len(questions_list)
        
        # æˆªæ–­æ–‡æ¡£å†…å®¹
        truncated_document_text = self._truncate_document(document_text)
        
        # æ ¹æ®æŒ‡æ ‡ç±»å‹å®šåˆ¶ç³»ç»Ÿæç¤º
        system_prompt = self._get_system_prompt_for_metric(metric_name)
        
        # åˆå§‹åŒ–æ¶ˆæ¯åˆ—è¡¨
        messages = [
            {'role': 'system', 'content': system_prompt},
            {'role': 'user', 'content': f"ä»¥ä¸‹æ˜¯å…³äº '{metric_name}' çš„æ•°æ®ï¼Œè¯·è®°ä½è¿™äº›ä¿¡æ¯ï¼š\n\n{truncated_document_text}"},
            {'role': 'assistant', 'content': f"æˆ‘å·²ç»åˆ†æäº†å…³äº '{metric_name}' çš„æ•°æ®ï¼Œå‡†å¤‡å›ç­”ç›¸å…³é—®é¢˜ã€‚"}
        ]
        
        try:
            # ç¡®è®¤æ–‡æ¡£å·²è¢«æ¥æ”¶
            print(f"  æ­£åœ¨å°† '{metric_name}' ç›¸å…³æ•°æ®å‘é€ç»™LLM...")
            completion = self.client.chat.completions.create(
                model=self.model_name,
                messages=messages,
                stream=False
            )
            
            if not completion.choices or not completion.choices[0].message:
                print("  è­¦å‘Š: LLMæœªèƒ½æ­£ç¡®æ¥æ”¶æ–‡æ¡£å†…å®¹")
                return ["LLMæœªèƒ½æ¥æ”¶æ–‡æ¡£å†…å®¹"] * len(questions_list)
            
            # å¤„ç†æ¯ä¸ªé—®é¢˜
            all_answers = []
            for question_text in questions_list:
                answer = self._process_single_question(messages.copy(), question_text, metric_name)
                all_answers.append(answer)
                
                # æ›´æ–°æ¶ˆæ¯å†å²
                messages.append({'role': 'user', 'content': self._get_question_prompt(question_text, metric_name)})
                messages.append({'role': 'assistant', 'content': answer})
            
            return all_answers
            
        except Exception as e:
            print(f"è°ƒç”¨LLM APIæ—¶å‘ç”Ÿé”™è¯¯: {e}")
            return [f"LLM APIè°ƒç”¨å¤±è´¥: {e}"] * len(questions_list)
    
    def _truncate_document(self, document_text):
        """æˆªæ–­æ–‡æ¡£å†…å®¹"""
        if len(document_text) > self.max_doc_length:
            print(f"  æ–‡æ¡£å†…å®¹è¿‡é•¿ ({len(document_text)} chars)ï¼Œå°†æˆªæ–­ä¸º {self.max_doc_length} å­—ç¬¦")
            return document_text[:self.max_doc_length]
        return document_text
    
    def _get_system_prompt_for_metric(self, metric_name):
        """æ ¹æ®æŒ‡æ ‡ç±»å‹è·å–ç³»ç»Ÿæç¤º"""
        if metric_name in METRIC_CATEGORIES['subject_metrics']:
            if 'ESI' in metric_name:
                return """ä½ æ˜¯ä¸€ä¸ªä¸“é—¨åˆ†æESIå­¦ç§‘æ’åæ•°æ®çš„AIåŠ©æ‰‹ã€‚
    ESIï¼ˆEssential Science Indicatorsï¼‰æ˜¯åŸºäºWeb of Scienceæ•°æ®åº“çš„å­¦ç§‘æ’åç³»ç»Ÿã€‚
    è¯·åœ¨æ•°æ®ä¸­å‡†ç¡®æŸ¥æ‰¾å’Œç»Ÿè®¡ESIç›¸å…³å­¦ç§‘ä¿¡æ¯ã€‚
    é‡ç‚¹å…³æ³¨ï¼šè¿›å…¥ESIå‰1%æˆ–å‰1â€°çš„å­¦ç§‘åç§°å’Œæ•°é‡ã€‚
    åªè¿”å›å‡†ç¡®çš„æ•°å­—ç­”æ¡ˆã€‚"""
            elif 'åŒä¸€æµ' in metric_name:
                return """ä½ æ˜¯ä¸€ä¸ªä¸“é—¨åˆ†æå›½å®¶åŒä¸€æµå­¦ç§‘å»ºè®¾æ•°æ®çš„AIåŠ©æ‰‹ã€‚
    åŒä¸€æµæŒ‡"ä¸–ç•Œä¸€æµå¤§å­¦å’Œä¸€æµå­¦ç§‘å»ºè®¾"ï¼Œæ˜¯å›½å®¶é‡å¤§æ•™è‚²æ”¿ç­–ã€‚
    è¯·åœ¨æ•™è‚²éƒ¨æ”¿ç­–æ•°æ®ä¸­å‡†ç¡®æŸ¥æ‰¾å’Œç»Ÿè®¡åŒä¸€æµå­¦ç§‘ä¿¡æ¯ã€‚
    é‡ç‚¹å…³æ³¨ï¼šå…¥é€‰å›½å®¶åŒä¸€æµå»ºè®¾çš„å­¦ç§‘åç§°å’Œæ•°é‡ã€‚
    åªè¿”å›å‡†ç¡®çš„æ•°å­—ç­”æ¡ˆã€‚"""
            elif 'æ•™è‚²éƒ¨è¯„ä¼°Aç±»' in metric_name:
                return """ä½ æ˜¯ä¸€ä¸ªä¸“é—¨åˆ†ææ•™è‚²éƒ¨å­¦ç§‘è¯„ä¼°æ•°æ®çš„AIåŠ©æ‰‹ã€‚
    æ•™è‚²éƒ¨å­¦ç§‘è¯„ä¼°æ˜¯å¯¹å…¨å›½å…·æœ‰åšå£«æˆ–ç¡•å£«å­¦ä½æˆäºˆæƒçš„ä¸€çº§å­¦ç§‘çš„æ•´ä½“æ°´å¹³è¯„ä¼°ã€‚
    Aç±»å­¦ç§‘åŒ…æ‹¬ï¼šA+ã€Aã€A-ä¸‰ä¸ªç­‰çº§ï¼Œä»£è¡¨è¯¥å­¦ç§‘åœ¨å…¨å›½æ’åå‰10%ã€‚
    è¯·åœ¨å­¦ç§‘è¯„ä¼°æ•°æ®ä¸­å‡†ç¡®æŸ¥æ‰¾å’Œç»Ÿè®¡Aç±»å­¦ç§‘ä¿¡æ¯ã€‚
    é‡ç‚¹å…³æ³¨ï¼šè·å¾—A+ã€Aã€A-è¯„çº§çš„å­¦ç§‘åç§°å’Œæ•°é‡ã€‚
    åªè¿”å›å‡†ç¡®çš„æ•°å­—ç­”æ¡ˆã€‚"""
            elif 'è½¯ç§‘' in metric_name:
                return """ä½ æ˜¯ä¸€ä¸ªä¸“é—¨åˆ†æè½¯ç§‘ä¸­å›½æœ€å¥½å­¦ç§‘æ’åæ•°æ®çš„AIåŠ©æ‰‹ã€‚
    è½¯ç§‘æ’åæ˜¯é‡è¦çš„å­¦ç§‘è¯„ä»·ä½“ç³»ï¼Œå‰10%è¡¨ç¤ºå­¦ç§‘å®åŠ›è¾ƒå¼ºã€‚
    è¯·åœ¨æ•°æ®ä¸­å‡†ç¡®æŸ¥æ‰¾å’Œç»Ÿè®¡è½¯ç§‘æ’åç›¸å…³ä¿¡æ¯ã€‚
    é‡ç‚¹å…³æ³¨ï¼šè¿›å…¥è½¯ç§‘æ’åå‰10%çš„å­¦ç§‘åç§°å’Œæ•°é‡ã€‚
    åªè¿”å›å‡†ç¡®çš„æ•°å­—ç­”æ¡ˆã€‚"""
            else:
                return """ä½ æ˜¯ä¸€ä¸ªä¸“é—¨åˆ†æä¸­å›½å¤§å­¦å­¦ç§‘æ•°æ®çš„AIåŠ©æ‰‹ã€‚
    è¯·å‡†ç¡®ç»Ÿè®¡å’Œè®¡ç®—å­¦ç§‘ç›¸å…³æŒ‡æ ‡ï¼Œé‡ç‚¹å…³æ³¨å­¦ç§‘æ•°é‡ã€‚
    åªè¿”å›å‡†ç¡®çš„æ•°å­—ç­”æ¡ˆã€‚"""
        
        elif metric_name in METRIC_CATEGORIES['major_metrics']:
            if 'ä¸“ä¸šæ€»æ•°' in metric_name:
                return """ä½ æ˜¯ä¸€ä¸ªä¸“é—¨åˆ†æé«˜ç­‰æ•™è‚²æœ¬ç§‘ä¸“ä¸šæ•°æ®çš„AIåŠ©æ‰‹ã€‚
    è¯·åœ¨æ•™è‚²éƒ¨æ”¿ç­–æ•°æ®å’Œä¸“ä¸šæ•°æ®ä¸­å‡†ç¡®æŸ¥æ‰¾å’Œç»Ÿè®¡æœ¬ç§‘ä¸“ä¸šæ€»æ•°ã€‚
    é‡ç‚¹å…³æ³¨ï¼šè¯¥å­¦æ ¡å¼€è®¾çš„æ‰€æœ‰æœ¬ç§‘ä¸“ä¸šæ•°é‡ã€‚
    åªè¿”å›å‡†ç¡®çš„æ•°å­—ç­”æ¡ˆã€‚"""
            elif 'ä¸€æµæœ¬ç§‘ä¸“ä¸š' in metric_name:
                return """ä½ æ˜¯ä¸€ä¸ªä¸“é—¨åˆ†æä¸€æµæœ¬ç§‘ä¸“ä¸šå»ºè®¾ç‚¹æ•°æ®çš„AIåŠ©æ‰‹ã€‚
    ä¸€æµæœ¬ç§‘ä¸“ä¸šå»ºè®¾ç‚¹åˆ†ä¸ºå›½å®¶çº§å’Œçœçº§ä¸¤ä¸ªå±‚æ¬¡ï¼Œæ˜¯æ•™è‚²éƒ¨æ¨è¿›ä¸€æµæœ¬ç§‘æ•™è‚²çš„é‡è¦ä¸¾æªã€‚
    è¯·åœ¨æ•™è‚²éƒ¨æ”¿ç­–æ•°æ®ä¸­å‡†ç¡®æŸ¥æ‰¾å’Œç»Ÿè®¡ä¸€æµæœ¬ç§‘ä¸“ä¸šå»ºè®¾ç‚¹ä¿¡æ¯ã€‚
    é‡ç‚¹å…³æ³¨ï¼šè·æ‰¹çš„å›½å®¶çº§æˆ–çœçº§ä¸€æµæœ¬ç§‘ä¸“ä¸šå»ºè®¾ç‚¹åç§°å’Œæ•°é‡ã€‚
    åªè¿”å›å‡†ç¡®çš„æ•°å­—ç­”æ¡ˆã€‚"""
                #  æ–°å¢å­¦ä½ç‚¹æŒ‡æ ‡çš„ç³»ç»Ÿæç¤º 
            elif metric_name == 'å­¦æœ¯å‹ç¡•å£«å­¦ä½ç‚¹':
                return """ä½ æ˜¯ä¸€ä¸ªä¸“é—¨åˆ†æå­¦æœ¯å‹ç¡•å£«å­¦ä½æˆæƒç‚¹æ•°æ®çš„AIåŠ©æ‰‹ã€‚
    å­¦æœ¯å‹ç¡•å£«å­¦ä½ç‚¹æ˜¯æŒ‡ä»¥åŸ¹å…»å­¦æœ¯ç ”ç©¶äººæ‰ä¸ºç›®æ ‡çš„ç¡•å£«å­¦ä½æˆæƒç‚¹ï¼Œæˆäºˆå­¦æœ¯å­¦ä½ã€‚
    è¯·åœ¨å­¦ä½ç‚¹æ•°æ®ä¸­å‡†ç¡®æŸ¥æ‰¾å’Œç»Ÿè®¡å­¦æœ¯å‹ç¡•å£«å­¦ä½ç‚¹ä¿¡æ¯ã€‚
    é‡ç‚¹å…³æ³¨ï¼šè·å¾—å­¦æœ¯å‹ç¡•å£«å­¦ä½æˆæƒçš„å­¦ç§‘æ•°é‡ï¼Œé€šå¸¸æŒ‰ä¸€çº§å­¦ç§‘ç»Ÿè®¡ã€‚
    æ³¨æ„åŒºåˆ†å­¦æœ¯å‹å’Œä¸“ä¸šå‹ç¡•å£«å­¦ä½ç‚¹ã€‚
    åªè¿”å›å‡†ç¡®çš„æ•°å­—ç­”æ¡ˆã€‚"""
            elif metric_name == 'ä¸“ä¸šå‹ç¡•å£«å­¦ä½ç‚¹':
                return """ä½ æ˜¯ä¸€ä¸ªä¸“é—¨åˆ†æä¸“ä¸šå‹ç¡•å£«å­¦ä½æˆæƒç‚¹æ•°æ®çš„AIåŠ©æ‰‹ã€‚
    ä¸“ä¸šå‹ç¡•å£«å­¦ä½ç‚¹æ˜¯æŒ‡ä»¥åŸ¹å…»åº”ç”¨å‹ä¸“é—¨äººæ‰ä¸ºç›®æ ‡çš„ç¡•å£«å­¦ä½æˆæƒç‚¹ï¼Œæˆäºˆä¸“ä¸šå­¦ä½ã€‚
    åŒ…æ‹¬MBAã€MPAã€MPAccã€å·¥ç¨‹ç¡•å£«ã€æ•™è‚²ç¡•å£«ç­‰å„ç±»ä¸“ä¸šå­¦ä½ã€‚
    è¯·åœ¨å­¦ä½ç‚¹æ•°æ®ä¸­å‡†ç¡®æŸ¥æ‰¾å’Œç»Ÿè®¡ä¸“ä¸šå‹ç¡•å£«å­¦ä½ç‚¹ä¿¡æ¯ã€‚
    é‡ç‚¹å…³æ³¨ï¼šè·å¾—ä¸“ä¸šå‹ç¡•å£«å­¦ä½æˆæƒçš„ä¸“ä¸šé¢†åŸŸæ•°é‡ã€‚
    æ³¨æ„åŒºåˆ†å­¦æœ¯å‹å’Œä¸“ä¸šå‹ç¡•å£«å­¦ä½ç‚¹ã€‚
    åªè¿”å›å‡†ç¡®çš„æ•°å­—ç­”æ¡ˆã€‚"""
            elif metric_name == 'å­¦æœ¯å‹åšå£«å­¦ä½ç‚¹':
                return """ä½ æ˜¯ä¸€ä¸ªä¸“é—¨åˆ†æå­¦æœ¯å‹åšå£«å­¦ä½æˆæƒç‚¹æ•°æ®çš„AIåŠ©æ‰‹ã€‚
    å­¦æœ¯å‹åšå£«å­¦ä½ç‚¹æ˜¯æŒ‡ä»¥åŸ¹å…»å­¦æœ¯ç ”ç©¶é«˜å±‚æ¬¡äººæ‰ä¸ºç›®æ ‡çš„åšå£«å­¦ä½æˆæƒç‚¹ï¼Œæˆäºˆå­¦æœ¯å­¦ä½ã€‚
    è¯·åœ¨å­¦ä½ç‚¹æ•°æ®ä¸­å‡†ç¡®æŸ¥æ‰¾å’Œç»Ÿè®¡å­¦æœ¯å‹åšå£«å­¦ä½ç‚¹ä¿¡æ¯ã€‚
    é‡ç‚¹å…³æ³¨ï¼šè·å¾—å­¦æœ¯å‹åšå£«å­¦ä½æˆæƒçš„å­¦ç§‘æ•°é‡ï¼Œé€šå¸¸æŒ‰ä¸€çº§å­¦ç§‘ç»Ÿè®¡ã€‚
    æ³¨æ„åŒºåˆ†å­¦æœ¯å‹å’Œä¸“ä¸šå‹åšå£«å­¦ä½ç‚¹ã€‚
    åªè¿”å›å‡†ç¡®çš„æ•°å­—ç­”æ¡ˆã€‚"""
            elif metric_name == 'ä¸“ä¸šå‹åšå£«å­¦ä½ç‚¹':
                return """ä½ æ˜¯ä¸€ä¸ªä¸“é—¨åˆ†æä¸“ä¸šå‹åšå£«å­¦ä½æˆæƒç‚¹æ•°æ®çš„AIåŠ©æ‰‹ã€‚
    ä¸“ä¸šå‹åšå£«å­¦ä½ç‚¹æ˜¯æŒ‡ä»¥åŸ¹å…»åº”ç”¨å‹é«˜å±‚æ¬¡ä¸“é—¨äººæ‰ä¸ºç›®æ ‡çš„åšå£«å­¦ä½æˆæƒç‚¹ï¼Œæˆäºˆä¸“ä¸šå­¦ä½ã€‚
    åŒ…æ‹¬å·¥ç¨‹åšå£«ã€æ•™è‚²åšå£«ã€ä¸´åºŠåŒ»å­¦åšå£«ç­‰ä¸“ä¸šå­¦ä½ã€‚
    è¯·åœ¨å­¦ä½ç‚¹æ•°æ®ä¸­å‡†ç¡®æŸ¥æ‰¾å’Œç»Ÿè®¡ä¸“ä¸šå‹åšå£«å­¦ä½ç‚¹ä¿¡æ¯ã€‚
    é‡ç‚¹å…³æ³¨ï¼šè·å¾—ä¸“ä¸šå‹åšå£«å­¦ä½æˆæƒçš„ä¸“ä¸šé¢†åŸŸæ•°é‡ã€‚
    æ³¨æ„åŒºåˆ†å­¦æœ¯å‹å’Œä¸“ä¸šå‹åšå£«å­¦ä½ç‚¹ã€‚
    åªè¿”å›å‡†ç¡®çš„æ•°å­—ç­”æ¡ˆã€‚"""
            else:
                return """ä½ æ˜¯ä¸€ä¸ªä¸“é—¨åˆ†æä¸­å›½å¤§å­¦æœ¬ç§‘ä¸“ä¸šæ•°æ®çš„AIåŠ©æ‰‹ã€‚
    è¯·åœ¨æ•™è‚²éƒ¨æ”¿ç­–æ•°æ®å’Œä¸“ä¸šæ•°æ®ä¸­å‡†ç¡®ç»Ÿè®¡å’Œè®¡ç®—æœ¬ç§‘ä¸“ä¸šç›¸å…³æŒ‡æ ‡ã€‚
    é‡ç‚¹å…³æ³¨ï¼šä¸“ä¸šæ•°é‡ç»Ÿè®¡ã€‚
    åªè¿”å›å‡†ç¡®çš„æ•°å­—ç­”æ¡ˆã€‚"""
        
        # ğŸ”¥ æ–°å¢æ•™å­¦ç›¸å…³æŒ‡æ ‡çš„ç³»ç»Ÿæç¤º ğŸ”¥
        elif metric_name in METRIC_CATEGORIES['teaching_metrics']:
            if 'æ•™å­¦æˆæœå¥–' in metric_name:
                if 'å›½å®¶çº§' in metric_name:
                    return """ä½ æ˜¯ä¸€ä¸ªä¸“é—¨åˆ†æå›½å®¶çº§æ•™å­¦æˆæœå¥–æ•°æ®çš„AIåŠ©æ‰‹ã€‚
    å›½å®¶çº§æ•™å­¦æˆæœå¥–æ˜¯ç”±å›½åŠ¡é™¢æ‰¹å‡†çš„æ•™è‚²æ•™å­¦ç ”ç©¶å’Œå®è·µé¢†åŸŸçš„æœ€é«˜å¥–é¡¹ï¼Œæ¯4å¹´è¯„é€‰ä¸€æ¬¡ã€‚
    è¯·åœ¨æ•™å­¦æˆæœæ•°æ®ä¸­å‡†ç¡®æŸ¥æ‰¾å’Œç»Ÿè®¡å›½å®¶çº§æ•™å­¦æˆæœå¥–ä¿¡æ¯ã€‚
    é‡ç‚¹å…³æ³¨ï¼šè·å¾—å›½å®¶çº§æ•™å­¦æˆæœå¥–çš„é¡¹ç›®æ•°é‡ï¼ˆåŒ…æ‹¬ç‰¹ç­‰å¥–ã€ä¸€ç­‰å¥–ã€äºŒç­‰å¥–ï¼‰ã€‚
    åªè¿”å›å‡†ç¡®çš„æ•°å­—ç­”æ¡ˆã€‚"""
                else:  # çœçº§æ•™å­¦æˆæœå¥–
                    return """ä½ æ˜¯ä¸€ä¸ªä¸“é—¨åˆ†æçœçº§æ•™å­¦æˆæœå¥–æ•°æ®çš„AIåŠ©æ‰‹ã€‚
    çœçº§æ•™å­¦æˆæœå¥–æ˜¯ç”±å„çœæ•™è‚²å…ç»„ç»‡è¯„é€‰çš„æ•™å­¦æˆæœå¥–é¡¹ã€‚
    è¯·åœ¨æ•™å­¦æˆæœæ•°æ®ä¸­å‡†ç¡®æŸ¥æ‰¾å’Œç»Ÿè®¡çœçº§æ•™å­¦æˆæœå¥–ä¿¡æ¯ã€‚
    é‡ç‚¹å…³æ³¨ï¼šè·å¾—çœçº§æ•™å­¦æˆæœå¥–çš„é¡¹ç›®æ•°é‡ï¼ˆåŒ…æ‹¬ç‰¹ç­‰å¥–ã€ä¸€ç­‰å¥–ã€äºŒç­‰å¥–ï¼‰ã€‚
    åªè¿”å›å‡†ç¡®çš„æ•°å­—ç­”æ¡ˆã€‚"""
            elif 'é’å¹´æ•™å¸ˆæ•™å­¦ç«èµ›' in metric_name:
                return """ä½ æ˜¯ä¸€ä¸ªä¸“é—¨åˆ†æå…¨å›½é«˜æ ¡é’å¹´æ•™å¸ˆæ•™å­¦ç«èµ›æ•°æ®çš„AIåŠ©æ‰‹ã€‚
    å…¨å›½é«˜æ ¡é’å¹´æ•™å¸ˆæ•™å­¦ç«èµ›æ˜¯ç”±ä¸­å›½æ•™ç§‘æ–‡å«ä½“å·¥ä¼šå…¨å›½å§”å‘˜ä¼šä¸»åŠçš„é‡è¦æ•™å­¦ç«èµ›ã€‚
    è¯·åœ¨æ•™å­¦ç«èµ›æ•°æ®ä¸­å‡†ç¡®æŸ¥æ‰¾å’Œç»Ÿè®¡é’å¹´æ•™å¸ˆæ•™å­¦ç«èµ›è·å¥–ä¿¡æ¯ã€‚
    é‡ç‚¹å…³æ³¨ï¼šåœ¨å…¨å›½é«˜æ ¡é’å¹´æ•™å¸ˆæ•™å­¦ç«èµ›ä¸­è·å¥–çš„æ•™å¸ˆäººæ•°æˆ–é¡¹ç›®æ•°é‡ã€‚
    åªè¿”å›å‡†ç¡®çš„æ•°å­—ç­”æ¡ˆã€‚"""
            elif 'ä¸€æµæœ¬ç§‘è¯¾ç¨‹' in metric_name:
                if 'å›½å®¶çº§' in metric_name:
                    return """ä½ æ˜¯ä¸€ä¸ªä¸“é—¨ç»Ÿè®¡å›½å®¶çº§ä¸€æµæœ¬ç§‘è¯¾ç¨‹æ•°é‡çš„AIåŠ©æ‰‹ã€‚

æ•°æ®æ ¼å¼è¯´æ˜ï¼š
- æ•°æ®ä»¥"å­¦æ ¡åï¼š"å¼€å¤´æ ‡è¯†æ¯ä¸ªå­¦æ ¡çš„è¯¾ç¨‹æ®µè½
- æ¯ä¸ªæ®µè½åŒ…å«è¯¥å­¦æ ¡çš„è¯¾ç¨‹åˆ—è¡¨
- è¯¾ç¨‹ä¿¡æ¯æ ¼å¼ï¼šå­¦æ ¡å + å¹³å°å + è¯¾ç¨‹åç§° + è´Ÿè´£äºº + å›¢é˜Ÿæˆå‘˜
- æ¯æ¬¡å‡ºç°å­¦æ ¡åç§°é€šå¸¸ä»£è¡¨ä¸€é—¨è¯¾ç¨‹

ç»Ÿè®¡è§„åˆ™ï¼š
1. å®šä½åˆ°è¯¢é—®å­¦æ ¡çš„ä¸“å±æ®µè½ï¼ˆ"å­¦æ ¡åï¼š"å¼€å¤´ï¼‰
2. åœ¨è¯¥æ®µè½ä¸­ç»Ÿè®¡å­¦æ ¡åç§°å‡ºç°çš„æ¬¡æ•°
3. æ¯æ¬¡å‡ºç°ä¸ä¸€å®šå¯¹åº”ä¸€é—¨å›½å®¶çº§ä¸€æµæœ¬ç§‘è¯¾ç¨‹ï¼Œå› ä¸ºå¯èƒ½æœ‰é‡å¤çš„è¯¾ç¨‹å†…å®¹ï¼Œä½ éœ€è¦æ ¸å¯¹æ˜¯å¦æ˜¯é‡å¤çš„è¯¾ç¨‹ï¼Œå»é™¤æ‰é‡å¤çš„è¯¾ç¨‹æ•°

é‡è¦ï¼šåªè¿”å›çº¯æ•°å­—ç­”æ¡ˆï¼Œä¸è¦ä»»ä½•è§£é‡Šæˆ–è¯´æ˜ã€‚å¦‚æœæ²¡æ‰¾åˆ°å¯¹åº”å­¦æ ¡ï¼Œè¿”å›"0"ã€‚

ç¤ºä¾‹å›ç­”æ ¼å¼ï¼š
- æ­£ç¡®ï¼š25
- é”™è¯¯ï¼šè¯¥å­¦æ ¡æœ‰25é—¨è¯¾ç¨‹
- é”™è¯¯ï¼šæ ¹æ®ç»Ÿè®¡ï¼Œæ•°é‡ä¸º25"""
                else:  # çœçº§ä¸€æµæœ¬ç§‘è¯¾ç¨‹
                    return """ä½ æ˜¯ä¸€ä¸ªä¸“é—¨åˆ†æçœçº§ä¸€æµæœ¬ç§‘è¯¾ç¨‹æ•°æ®çš„AIåŠ©æ‰‹ã€‚
    çœçº§ä¸€æµæœ¬ç§‘è¯¾ç¨‹æ˜¯ç”±å„çœæ•™è‚²å…è®¤å®šçš„ä¼˜è´¨æœ¬ç§‘è¯¾ç¨‹ã€‚
    è¯·åœ¨è¯¾ç¨‹æ•°æ®ä¸­å‡†ç¡®æŸ¥æ‰¾å’Œç»Ÿè®¡çœçº§ä¸€æµæœ¬ç§‘è¯¾ç¨‹ä¿¡æ¯ã€‚
    é‡ç‚¹å…³æ³¨ï¼šè·æ‰¹çœçº§ä¸€æµæœ¬ç§‘è¯¾ç¨‹çš„è¯¾ç¨‹æ•°é‡ã€‚
    åªè¿”å›å‡†ç¡®çš„æ•°å­—ç­”æ¡ˆã€‚"""
            elif 'æ™ºæ…§å¹³å°è¯¾ç¨‹' in metric_name:
                if 'å›½å®¶çº§' in metric_name:
                    return """ä½ æ˜¯ä¸€ä¸ªä¸“é—¨åˆ†æå›½å®¶é«˜ç­‰æ•™è‚²æ™ºæ…§å¹³å°è¯¾ç¨‹æ•°æ®çš„AIåŠ©æ‰‹ã€‚
    å›½å®¶é«˜ç­‰æ•™è‚²æ™ºæ…§å¹³å°æ˜¯æ•™è‚²éƒ¨æ¨å‡ºçš„åœ¨çº¿æ•™è‚²å¹³å°ï¼Œæ±‡èšä¼˜è´¨è¯¾ç¨‹èµ„æºã€‚
    è¯·åœ¨æ™ºæ…§å¹³å°æ•°æ®ä¸­å‡†ç¡®æŸ¥æ‰¾å’Œç»Ÿè®¡å›½å®¶çº§æ™ºæ…§å¹³å°è¯¾ç¨‹ä¿¡æ¯ã€‚
    é‡ç‚¹å…³æ³¨ï¼šä¸Šçº¿å›½å®¶é«˜ç­‰æ•™è‚²æ™ºæ…§å¹³å°çš„è¯¾ç¨‹æ•°é‡ã€‚
    åªè¿”å›å‡†ç¡®çš„æ•°å­—ç­”æ¡ˆã€‚"""
                else:  # çœçº§æ™ºæ…§å¹³å°è¯¾ç¨‹
                    return """ä½ æ˜¯ä¸€ä¸ªä¸“é—¨åˆ†æçœçº§é«˜ç­‰æ•™è‚²æ™ºæ…§å¹³å°è¯¾ç¨‹æ•°æ®çš„AIåŠ©æ‰‹ã€‚
    çœçº§é«˜ç­‰æ•™è‚²æ™ºæ…§å¹³å°æ˜¯å„çœæ¨å‡ºçš„åœ¨çº¿æ•™è‚²å¹³å°ã€‚
    è¯·åœ¨æ™ºæ…§å¹³å°æ•°æ®ä¸­å‡†ç¡®æŸ¥æ‰¾å’Œç»Ÿè®¡çœçº§æ™ºæ…§å¹³å°è¯¾ç¨‹ä¿¡æ¯ã€‚
    é‡ç‚¹å…³æ³¨ï¼šä¸Šçº¿çœçº§é«˜ç­‰æ•™è‚²æ™ºæ…§å¹³å°çš„è¯¾ç¨‹æ•°é‡ã€‚
    åªè¿”å›å‡†ç¡®çš„æ•°å­—ç­”æ¡ˆã€‚"""
            else:
                return """ä½ æ˜¯ä¸€ä¸ªä¸“é—¨åˆ†æä¸­å›½å¤§å­¦æ•™å­¦ç›¸å…³æ•°æ®çš„AIåŠ©æ‰‹ã€‚
    è¯·å‡†ç¡®ç»Ÿè®¡å’Œè®¡ç®—æ•™å­¦ç›¸å…³æŒ‡æ ‡ï¼Œé‡ç‚¹å…³æ³¨æ•™å­¦æˆæœã€è¯¾ç¨‹ã€ç«èµ›ç­‰æ•°é‡ã€‚
    åªè¿”å›å‡†ç¡®çš„æ•°å­—ç­”æ¡ˆã€‚"""
        
        else:
            return "ä½ æ˜¯ä¸€ä¸ªä¸“é—¨åˆ†æä¸­å›½å¤§å­¦æ•°æ®çš„AIåŠ©æ‰‹ã€‚è¯·å‡†ç¡®ç»Ÿè®¡å’Œè®¡ç®—ç›¸å…³æŒ‡æ ‡ã€‚åªè¿”å›å‡†ç¡®çš„æ•°å­—ç­”æ¡ˆã€‚"
    
    def _get_question_prompt(self, question_text, metric_name):
        """æ ¹æ®æŒ‡æ ‡ç±»å‹è·å–ä¼˜åŒ–çš„é—®é¢˜æç¤º"""
        # ...existing code...
        base_prompt = f"é—®é¢˜ï¼š{question_text}\n\n"
        
        # è·å–æŒ‡æ ‡å…³é”®è¯
        keywords = METRIC_KEYWORDS.get(metric_name, [])
        keywords_str = "ã€".join(keywords) if keywords else metric_name
        
        # ğŸ”¥ ESIæŒ‡æ ‡å¤„ç†ï¼ˆå·²å­˜åœ¨ï¼Œä¿æŒä¸å˜ï¼‰ğŸ”¥
        if metric_name == 'ESIå‰1%å­¦ç§‘æ•°é‡':
            return base_prompt + f"""è¯·åœ¨æ•°æ®ä¸­æŸ¥æ‰¾ESIç›¸å…³ä¿¡æ¯ï¼Œé‡ç‚¹å…³æ³¨ä»¥ä¸‹å…³é”®è¯ï¼š{keywords_str}ã€‚
    æŸ¥æ‰¾è¿›å…¥ESIå‰1%çš„å­¦ç§‘ï¼Œå¹¶ç»Ÿè®¡æ•°é‡ã€‚
    å¦‚æœæ•°æ®ä¸­æ˜ç¡®æåˆ°ESIå‰1%å­¦ç§‘ï¼Œè¯·ç»Ÿè®¡å…·ä½“æ•°é‡ã€‚
    åªè¿”å›æ•°å­—ç­”æ¡ˆï¼Œå¦‚æœæ‰¾ä¸åˆ°ç›¸å…³ä¿¡æ¯ï¼Œè¯·å›ç­”"0"ã€‚"""
        
        elif metric_name == 'ESIå‰1â€°å­¦ç§‘æ•°é‡':
            return base_prompt + f"""è¯·åœ¨æ•°æ®ä¸­æŸ¥æ‰¾ESIç›¸å…³ä¿¡æ¯ï¼Œé‡ç‚¹å…³æ³¨ä»¥ä¸‹å…³é”®è¯ï¼š{keywords_str}ã€‚
    æŸ¥æ‰¾è¿›å…¥ESIå‰1â€°ï¼ˆåƒåˆ†ä¹‹ä¸€ï¼‰çš„å­¦ç§‘ï¼Œå¹¶ç»Ÿè®¡æ•°é‡ã€‚
    å¦‚æœæ•°æ®ä¸­æ˜ç¡®æåˆ°ESIå‰1â€°å­¦ç§‘ï¼Œè¯·ç»Ÿè®¡å…·ä½“æ•°é‡ã€‚
    åªè¿”å›æ•°å­—ç­”æ¡ˆï¼Œå¦‚æœæ‰¾ä¸åˆ°ç›¸å…³ä¿¡æ¯ï¼Œè¯·å›ç­”"0"ã€‚"""
        
        elif metric_name == 'å›½å®¶åŒä¸€æµå­¦ç§‘æ•°é‡':
            return base_prompt + f"""è¯·åœ¨æ•™è‚²éƒ¨æ”¿ç­–æ•°æ®ä¸­æŸ¥æ‰¾åŒä¸€æµç›¸å…³ä¿¡æ¯ï¼Œé‡ç‚¹å…³æ³¨ä»¥ä¸‹å…³é”®è¯ï¼š{keywords_str}ã€‚
    æŸ¥æ‰¾å…¥é€‰å›½å®¶"åŒä¸€æµ"å­¦ç§‘å»ºè®¾çš„å­¦ç§‘ï¼Œå¹¶ç»Ÿè®¡æ•°é‡ã€‚
    æ³¨æ„åŒºåˆ†"åŒä¸€æµå¤§å­¦"å’Œ"åŒä¸€æµå­¦ç§‘"ï¼Œè¿™é‡Œåªç»Ÿè®¡å­¦ç§‘æ•°é‡ã€‚
    åªè¿”å›æ•°å­—ç­”æ¡ˆï¼Œå¦‚æœæ‰¾ä¸åˆ°ç›¸å…³ä¿¡æ¯ï¼Œè¯·å›ç­”"0"ã€‚"""
        
        elif metric_name == 'æ•™è‚²éƒ¨è¯„ä¼°Aç±»å­¦ç§‘æ•°é‡':
            return base_prompt + f"""è¯·åœ¨å­¦ç§‘è¯„ä¼°æ•°æ®ä¸­æŸ¥æ‰¾æ•™è‚²éƒ¨è¯„ä¼°ç›¸å…³ä¿¡æ¯ï¼Œé‡ç‚¹å…³æ³¨ä»¥ä¸‹å…³é”®è¯ï¼š{keywords_str}ã€‚
    æŸ¥æ‰¾åœ¨æ•™è‚²éƒ¨å­¦ç§‘è¯„ä¼°ä¸­è·å¾—Aç±»è¯„çº§ï¼ˆA+ã€Aã€A-ï¼‰çš„å­¦ç§‘ï¼Œå¹¶ç»Ÿè®¡æ•°é‡ã€‚
    æ³¨æ„ï¼š
    - A+è¡¨ç¤ºå‰2%æˆ–å‰2åï¼ˆè¯¥å­¦ç§‘å…¨å›½æ’åæœ€é«˜ï¼‰
    - Aè¡¨ç¤ºå‰2%-5%
    - A-è¡¨ç¤ºå‰5%-10%
    - è¿™ä¸‰ä¸ªç­‰çº§ç»Ÿç§°ä¸ºAç±»å­¦ç§‘
    å¦‚æœæ•°æ®ä¸­æ˜ç¡®æåˆ°å­¦ç§‘è¯„ä¼°A+ã€Aã€A-ç­‰çº§ï¼Œè¯·ç»Ÿè®¡å…·ä½“æ•°é‡ã€‚
    åªè¿”å›æ•°å­—ç­”æ¡ˆï¼Œå¦‚æœæ‰¾ä¸åˆ°ç›¸å…³ä¿¡æ¯ï¼Œè¯·å›ç­”"0"ã€‚"""
        
        # ğŸ”¥ æ–°å¢è½¯ç§‘æŒ‡æ ‡å¤„ç† ğŸ”¥
        elif metric_name == 'è½¯ç§‘ä¸­å›½æœ€å¥½å­¦ç§‘æ’åå‰10%å­¦ç§‘æ•°é‡':
            return base_prompt + f"""è¯·åœ¨æ•°æ®ä¸­æŸ¥æ‰¾è½¯ç§‘æ’åç›¸å…³ä¿¡æ¯ï¼Œé‡ç‚¹å…³æ³¨ä»¥ä¸‹å…³é”®è¯ï¼š{keywords_str}ã€‚
    æŸ¥æ‰¾åœ¨è½¯ç§‘"ä¸­å›½æœ€å¥½å­¦ç§‘"æ’åä¸­è¿›å…¥å‰10%çš„å­¦ç§‘ï¼Œå¹¶ç»Ÿè®¡æ•°é‡ã€‚
    é‡ç‚¹æŸ¥æ‰¾ï¼šæ’åç™¾åˆ†ä½å‰10%çš„å­¦ç§‘ï¼Œæˆ–æ˜ç¡®æ ‡æ³¨ä¸º"å‰10%"çš„å­¦ç§‘ã€‚
    åªè¿”å›æ•°å­—ç­”æ¡ˆï¼Œå¦‚æœæ‰¾ä¸åˆ°ç›¸å…³ä¿¡æ¯ï¼Œè¯·å›ç­”"0"ã€‚"""
        
        elif metric_name == 'æœ¬ç§‘ä¸“ä¸šæ€»æ•°':
            return base_prompt + f"""è¯·åœ¨æ•™è‚²éƒ¨æ”¿ç­–æ•°æ®å’Œä¸“ä¸šæ•°æ®ä¸­æŸ¥æ‰¾æœ¬ç§‘ä¸“ä¸šç›¸å…³ä¿¡æ¯ï¼Œé‡ç‚¹å…³æ³¨ä»¥ä¸‹å…³é”®è¯ï¼š{keywords_str}ã€‚
    ç»Ÿè®¡è¯¥å­¦æ ¡çš„æœ¬ç§‘ä¸“ä¸šæ€»æ•°ï¼ŒåŒ…æ‹¬æ‰€æœ‰æœ¬ç§‘ä¸“ä¸šã€‚
    æŸ¥æ‰¾ä¸“ä¸šç›®å½•ã€ä¸“ä¸šè®¾ç½®ç­‰ç›¸å…³ä¿¡æ¯ï¼Œç»Ÿè®¡å¼€è®¾çš„æœ¬ç§‘ä¸“ä¸šæ•°é‡ã€‚
    åªè¿”å›æ•°å­—ç­”æ¡ˆï¼Œå¦‚æœæ‰¾ä¸åˆ°ç›¸å…³ä¿¡æ¯ï¼Œè¯·å›ç­”"0"ã€‚"""
        
        elif metric_name == 'å›½å®¶çº§ä¸€æµæœ¬ç§‘ä¸“ä¸šå»ºè®¾ç‚¹':
            return base_prompt + f"""è¯·åœ¨æ•™è‚²éƒ¨æ”¿ç­–æ•°æ®ä¸­æŸ¥æ‰¾ä¸€æµæœ¬ç§‘ä¸“ä¸šç›¸å…³ä¿¡æ¯ï¼Œé‡ç‚¹å…³æ³¨ä»¥ä¸‹å…³é”®è¯ï¼š{keywords_str}ã€‚
    æŸ¥æ‰¾è·æ‰¹å›½å®¶çº§ä¸€æµæœ¬ç§‘ä¸“ä¸šå»ºè®¾ç‚¹çš„ä¸“ä¸šï¼Œå¹¶ç»Ÿè®¡æ•°é‡ã€‚
    æ³¨æ„åŒºåˆ†å›½å®¶çº§å’Œçœçº§ï¼Œè¿™é‡Œåªç»Ÿè®¡å›½å®¶çº§ã€‚
    åªè¿”å›æ•°å­—ç­”æ¡ˆï¼Œå¦‚æœæ‰¾ä¸åˆ°ç›¸å…³ä¿¡æ¯ï¼Œè¯·å›ç­”"0"ã€‚"""
        
        elif metric_name == 'çœçº§ä¸€æµæœ¬ç§‘ä¸“ä¸šå»ºè®¾ç‚¹':
            return base_prompt + f"""è¯·åœ¨æ•™è‚²éƒ¨æ”¿ç­–æ•°æ®ä¸­æŸ¥æ‰¾ä¸€æµæœ¬ç§‘ä¸“ä¸šç›¸å…³ä¿¡æ¯ï¼Œé‡ç‚¹å…³æ³¨ä»¥ä¸‹å…³é”®è¯ï¼š{keywords_str}ã€‚
    æŸ¥æ‰¾è·æ‰¹çœçº§ä¸€æµæœ¬ç§‘ä¸“ä¸šå»ºè®¾ç‚¹çš„ä¸“ä¸šï¼Œå¹¶ç»Ÿè®¡æ•°é‡ã€‚
    æ³¨æ„åŒºåˆ†å›½å®¶çº§å’Œçœçº§ï¼Œè¿™é‡Œåªç»Ÿè®¡çœçº§ï¼ˆæˆ–çœä¸€æµï¼‰ã€‚
    åªè¿”å›æ•°å­—ç­”æ¡ˆï¼Œå¦‚æœæ‰¾ä¸åˆ°ç›¸å…³ä¿¡æ¯ï¼Œè¯·å›ç­”"0"ã€‚"""
        
        # ğŸ”¥ æ–°å¢æ•™å­¦æˆæœå¥–æŒ‡æ ‡å¤„ç† ğŸ”¥
        elif metric_name == 'å›½å®¶çº§æ•™å­¦æˆæœå¥–':
            return base_prompt + f"""è¯·åœ¨æ•™å­¦æˆæœæ•°æ®ä¸­æŸ¥æ‰¾å›½å®¶çº§æ•™å­¦æˆæœå¥–ç›¸å…³ä¿¡æ¯ï¼Œé‡ç‚¹å…³æ³¨ä»¥ä¸‹å…³é”®è¯ï¼š{keywords_str}ã€‚
    æŸ¥æ‰¾è·å¾—å›½å®¶çº§æ•™å­¦æˆæœå¥–çš„é¡¹ç›®ï¼Œå¹¶ç»Ÿè®¡æ•°é‡ã€‚
    åŒ…æ‹¬ï¼šå›½å®¶çº§æ•™å­¦æˆæœå¥–ç‰¹ç­‰å¥–ã€ä¸€ç­‰å¥–ã€äºŒç­‰å¥–ã€‚
    åªè¿”å›æ•°å­—ç­”æ¡ˆï¼Œå¦‚æœæ‰¾ä¸åˆ°ç›¸å…³ä¿¡æ¯ï¼Œè¯·å›ç­”"0"ã€‚"""
        
        elif metric_name == 'çœçº§æ•™å­¦æˆæœå¥–':
            return base_prompt + f"""è¯·åœ¨æ•™å­¦æˆæœæ•°æ®ä¸­æŸ¥æ‰¾çœçº§æ•™å­¦æˆæœå¥–ç›¸å…³ä¿¡æ¯ï¼Œé‡ç‚¹å…³æ³¨ä»¥ä¸‹å…³é”®è¯ï¼š{keywords_str}ã€‚
    æŸ¥æ‰¾è·å¾—çœçº§æ•™å­¦æˆæœå¥–çš„é¡¹ç›®ï¼Œå¹¶ç»Ÿè®¡æ•°é‡ã€‚
    åŒ…æ‹¬ï¼šçœçº§æ•™å­¦æˆæœå¥–ç‰¹ç­‰å¥–ã€ä¸€ç­‰å¥–ã€äºŒç­‰å¥–ã€‚
    åªè¿”å›æ•°å­—ç­”æ¡ˆï¼Œå¦‚æœæ‰¾ä¸åˆ°ç›¸å…³ä¿¡æ¯ï¼Œè¯·å›ç­”"0"ã€‚"""
        
        elif metric_name == 'å…¨å›½é«˜æ ¡é’å¹´æ•™å¸ˆæ•™å­¦ç«èµ›':
            return base_prompt + f"""è¯·åœ¨æ•™å­¦ç«èµ›æ•°æ®ä¸­æŸ¥æ‰¾é’å¹´æ•™å¸ˆæ•™å­¦ç«èµ›ç›¸å…³ä¿¡æ¯ï¼Œé‡ç‚¹å…³æ³¨ä»¥ä¸‹å…³é”®è¯ï¼š{keywords_str}ã€‚
    æŸ¥æ‰¾åœ¨å…¨å›½é«˜æ ¡é’å¹´æ•™å¸ˆæ•™å­¦ç«èµ›ä¸­è·å¥–çš„æƒ…å†µï¼Œå¹¶ç»Ÿè®¡è·å¥–æ•°é‡ã€‚
    åŒ…æ‹¬ï¼šå…¨å›½ä¸€ç­‰å¥–ã€äºŒç­‰å¥–ã€ä¸‰ç­‰å¥–ç­‰å„çº§å¥–é¡¹ã€‚
    åªè¿”å›æ•°å­—ç­”æ¡ˆï¼Œå¦‚æœæ‰¾ä¸åˆ°ç›¸å…³ä¿¡æ¯ï¼Œè¯·å›ç­”"0"ã€‚"""
        elif metric_name == 'å­¦æœ¯å‹ç¡•å£«å­¦ä½ç‚¹':
            return base_prompt + f"""è¯·åœ¨å­¦ä½ç‚¹æ•°æ®ä¸­æŸ¥æ‰¾å­¦æœ¯å‹ç¡•å£«å­¦ä½ç‚¹ç›¸å…³ä¿¡æ¯ï¼Œé‡ç‚¹å…³æ³¨ä»¥ä¸‹å…³é”®è¯ï¼š{keywords_str}ã€‚
    æŸ¥æ‰¾è¯¥å­¦æ ¡è·å¾—çš„å­¦æœ¯å‹ç¡•å£«å­¦ä½æˆæƒç‚¹ï¼Œå¹¶ç»Ÿè®¡æ•°é‡ã€‚
    é‡ç‚¹æŸ¥æ‰¾ï¼šå­¦æœ¯å‹ç¡•å£«ã€å­¦æœ¯ç¡•å£«ã€ç¡•å£«å­¦ä½æˆæƒç‚¹ï¼ˆå­¦æœ¯å‹ï¼‰ç­‰ä¿¡æ¯ã€‚
    æ³¨æ„åŒºåˆ†å­¦æœ¯å‹å’Œä¸“ä¸šå‹ï¼Œåªç»Ÿè®¡å­¦æœ¯å‹ç¡•å£«å­¦ä½ç‚¹ã€‚
    é€šå¸¸æŒ‰ä¸€çº§å­¦ç§‘è¿›è¡Œç»Ÿè®¡ã€‚
    åªè¿”å›æ•°å­—ç­”æ¡ˆï¼Œå¦‚æœæ‰¾ä¸åˆ°ç›¸å…³ä¿¡æ¯ï¼Œè¯·å›ç­”"0"ã€‚"""
        
        elif metric_name == 'ä¸“ä¸šå‹ç¡•å£«å­¦ä½ç‚¹':
            return base_prompt + f"""è¯·åœ¨å­¦ä½ç‚¹æ•°æ®ä¸­æŸ¥æ‰¾ä¸“ä¸šå‹ç¡•å£«å­¦ä½ç‚¹ç›¸å…³ä¿¡æ¯ï¼Œé‡ç‚¹å…³æ³¨ä»¥ä¸‹å…³é”®è¯ï¼š{keywords_str}ã€‚
    æŸ¥æ‰¾è¯¥å­¦æ ¡è·å¾—çš„ä¸“ä¸šå‹ç¡•å£«å­¦ä½æˆæƒç‚¹ï¼Œå¹¶ç»Ÿè®¡æ•°é‡ã€‚
    é‡ç‚¹æŸ¥æ‰¾ï¼šä¸“ä¸šå‹ç¡•å£«ã€ä¸“ä¸šç¡•å£«ã€MBAã€MPAã€MPAccã€å·¥ç¨‹ç¡•å£«ã€æ•™è‚²ç¡•å£«ç­‰ä¸“ä¸šå­¦ä½ä¿¡æ¯ã€‚
    æ³¨æ„åŒºåˆ†å­¦æœ¯å‹å’Œä¸“ä¸šå‹ï¼Œåªç»Ÿè®¡ä¸“ä¸šå‹ç¡•å£«å­¦ä½ç‚¹ã€‚
    æŒ‰ä¸“ä¸šå­¦ä½ç±»åˆ«è¿›è¡Œç»Ÿè®¡ã€‚
    åªè¿”å›æ•°å­—ç­”æ¡ˆï¼Œå¦‚æœæ‰¾ä¸åˆ°ç›¸å…³ä¿¡æ¯ï¼Œè¯·å›ç­”"0"ã€‚"""
        
        elif metric_name == 'å­¦æœ¯å‹åšå£«å­¦ä½ç‚¹':
            return base_prompt + f"""è¯·åœ¨å­¦ä½ç‚¹æ•°æ®ä¸­æŸ¥æ‰¾å­¦æœ¯å‹åšå£«å­¦ä½ç‚¹ç›¸å…³ä¿¡æ¯ï¼Œé‡ç‚¹å…³æ³¨ä»¥ä¸‹å…³é”®è¯ï¼š{keywords_str}ã€‚
    æŸ¥æ‰¾è¯¥å­¦æ ¡è·å¾—çš„å­¦æœ¯å‹åšå£«å­¦ä½æˆæƒç‚¹ï¼Œå¹¶ç»Ÿè®¡æ•°é‡ã€‚
    é‡ç‚¹æŸ¥æ‰¾ï¼šå­¦æœ¯å‹åšå£«ã€å­¦æœ¯åšå£«ã€åšå£«å­¦ä½æˆæƒç‚¹ï¼ˆå­¦æœ¯å‹ï¼‰ç­‰ä¿¡æ¯ã€‚
    æ³¨æ„åŒºåˆ†å­¦æœ¯å‹å’Œä¸“ä¸šå‹ï¼Œåªç»Ÿè®¡å­¦æœ¯å‹åšå£«å­¦ä½ç‚¹ã€‚
    é€šå¸¸æŒ‰ä¸€çº§å­¦ç§‘è¿›è¡Œç»Ÿè®¡ã€‚
    åªè¿”å›æ•°å­—ç­”æ¡ˆï¼Œå¦‚æœæ‰¾ä¸åˆ°ç›¸å…³ä¿¡æ¯ï¼Œè¯·å›ç­”"0"ã€‚"""
        
        elif metric_name == 'ä¸“ä¸šå‹åšå£«å­¦ä½ç‚¹':
            return base_prompt + f"""è¯·åœ¨å­¦ä½ç‚¹æ•°æ®ä¸­æŸ¥æ‰¾ä¸“ä¸šå‹åšå£«å­¦ä½ç‚¹ç›¸å…³ä¿¡æ¯ï¼Œé‡ç‚¹å…³æ³¨ä»¥ä¸‹å…³é”®è¯ï¼š{keywords_str}ã€‚
    æŸ¥æ‰¾è¯¥å­¦æ ¡è·å¾—çš„ä¸“ä¸šå‹åšå£«å­¦ä½æˆæƒç‚¹ï¼Œå¹¶ç»Ÿè®¡æ•°é‡ã€‚
    é‡ç‚¹æŸ¥æ‰¾ï¼šä¸“ä¸šå‹åšå£«ã€ä¸“ä¸šåšå£«ã€å·¥ç¨‹åšå£«ã€æ•™è‚²åšå£«ã€ä¸´åºŠåŒ»å­¦åšå£«ç­‰ä¸“ä¸šå­¦ä½ä¿¡æ¯ã€‚
    æ³¨æ„åŒºåˆ†å­¦æœ¯å‹å’Œä¸“ä¸šå‹ï¼Œåªç»Ÿè®¡ä¸“ä¸šå‹åšå£«å­¦ä½ç‚¹ã€‚
    æŒ‰ä¸“ä¸šå­¦ä½ç±»åˆ«è¿›è¡Œç»Ÿè®¡ã€‚
    åªè¿”å›æ•°å­—ç­”æ¡ˆï¼Œå¦‚æœæ‰¾ä¸åˆ°ç›¸å…³ä¿¡æ¯ï¼Œè¯·å›ç­”"0"ã€‚"""
        
        # ğŸ”¥ æ–°å¢ä¸€æµè¯¾ç¨‹æŒ‡æ ‡å¤„ç† ğŸ”¥
        elif metric_name == 'å›½å®¶çº§ä¸€æµæœ¬ç§‘è¯¾ç¨‹':
            return base_prompt + f"""æ•°æ®ç»Ÿè®¡è¯´æ˜ï¼š
- æ•°æ®ä»¥"å­¦æ ¡åï¼š"å¼€å¤´æ ‡è¯†æ¯ä¸ªå­¦æ ¡çš„è¯¾ç¨‹æ®µè½
- åœ¨è¯¢é—®å­¦æ ¡çš„æ®µè½ä¸­ï¼Œç»Ÿè®¡è¯¥å­¦æ ¡åç§°å‡ºç°çš„æ¬¡æ•°
- æ¯æ¬¡å­¦æ ¡åç§°å‡ºç° = ä¸€é—¨å›½å®¶çº§ä¸€æµæœ¬ç§‘è¯¾ç¨‹

ç»Ÿè®¡æ­¥éª¤ï¼š
1. æ‰¾åˆ°"[è¯¢é—®çš„å­¦æ ¡å]ï¼š"å¼€å¤´çš„æ®µè½
2. ç»Ÿè®¡è¯¥æ®µè½ä¸­è¯¥å­¦æ ¡åç§°çš„å‡ºç°æ¬¡æ•°
3. è¿”å›ç»Ÿè®¡æ•°å­—

æ³¨æ„ï¼š
- åªç»Ÿè®¡è¯¢é—®å­¦æ ¡è‡ªå·±çš„è¯¾ç¨‹
- ä¸è¦ç»Ÿè®¡å…¶ä»–å­¦æ ¡çš„è¯¾ç¨‹
- å¿…é¡»åªè¿”å›çº¯æ•°å­—ç­”æ¡ˆ
- æ‰¾ä¸åˆ°å¯¹åº”å­¦æ ¡ä¿¡æ¯æ—¶è¿”å›"0"

ç°åœ¨è¯·ç»Ÿè®¡å¹¶åªè¿”å›æ•°å­—ç­”æ¡ˆï¼š"""
        
        elif metric_name == 'çœçº§ä¸€æµæœ¬ç§‘è¯¾ç¨‹':
            return base_prompt + f"""è¯·åœ¨è¯¾ç¨‹æ•°æ®ä¸­æŸ¥æ‰¾çœçº§ä¸€æµæœ¬ç§‘è¯¾ç¨‹ç›¸å…³ä¿¡æ¯ï¼Œé‡ç‚¹å…³æ³¨ä»¥ä¸‹å…³é”®è¯ï¼š{keywords_str}ã€‚
    æŸ¥æ‰¾è·æ‰¹çœçº§ä¸€æµæœ¬ç§‘è¯¾ç¨‹çš„è¯¾ç¨‹ï¼Œå¹¶ç»Ÿè®¡æ•°é‡ã€‚
    åŒ…æ‹¬å„ç§ç±»å‹çš„çœçº§ä¸€æµæœ¬ç§‘è¯¾ç¨‹ã€‚
    åªè¿”å›æ•°å­—ç­”æ¡ˆï¼Œå¦‚æœæ‰¾ä¸åˆ°ç›¸å…³ä¿¡æ¯ï¼Œè¯·å›ç­”"0"ã€‚"""
        
        # ğŸ”¥ æ–°å¢æ™ºæ…§å¹³å°è¯¾ç¨‹æŒ‡æ ‡å¤„ç† ğŸ”¥
        elif metric_name == 'å›½å®¶çº§é«˜ç­‰æ•™è‚²æ™ºæ…§å¹³å°è¯¾ç¨‹':
            return base_prompt + f"""è¯·åœ¨æ™ºæ…§å¹³å°æ•°æ®ä¸­æŸ¥æ‰¾å›½å®¶çº§æ™ºæ…§å¹³å°è¯¾ç¨‹ç›¸å…³ä¿¡æ¯ï¼Œé‡ç‚¹å…³æ³¨ä»¥ä¸‹å…³é”®è¯ï¼š{keywords_str}ã€‚
    æŸ¥æ‰¾ä¸Šçº¿å›½å®¶é«˜ç­‰æ•™è‚²æ™ºæ…§å¹³å°çš„è¯¾ç¨‹ï¼Œå¹¶ç»Ÿè®¡æ•°é‡ã€‚
    é‡ç‚¹æŸ¥æ‰¾ï¼šåœ¨å›½å®¶æ™ºæ…§æ•™è‚²å¹³å°ã€å›½å®¶é«˜ç­‰æ•™è‚²æ™ºæ…§å¹³å°ç­‰ä¸Šçº¿çš„è¯¾ç¨‹ã€‚
    åªè¿”å›æ•°å­—ç­”æ¡ˆï¼Œå¦‚æœæ‰¾ä¸åˆ°ç›¸å…³ä¿¡æ¯ï¼Œè¯·å›ç­”"0"ã€‚"""
        
        elif metric_name == 'çœçº§é«˜ç­‰æ•™è‚²æ™ºæ…§å¹³å°è¯¾ç¨‹':
            return base_prompt + f"""è¯·åœ¨æ™ºæ…§å¹³å°æ•°æ®ä¸­æŸ¥æ‰¾çœçº§æ™ºæ…§å¹³å°è¯¾ç¨‹ç›¸å…³ä¿¡æ¯ï¼Œé‡ç‚¹å…³æ³¨ä»¥ä¸‹å…³é”®è¯ï¼š{keywords_str}ã€‚
    æŸ¥æ‰¾ä¸Šçº¿çœçº§é«˜ç­‰æ•™è‚²æ™ºæ…§å¹³å°çš„è¯¾ç¨‹ï¼Œå¹¶ç»Ÿè®¡æ•°é‡ã€‚
    é‡ç‚¹æŸ¥æ‰¾ï¼šåœ¨çœçº§æ™ºæ…§æ•™è‚²å¹³å°ä¸Šçº¿çš„è¯¾ç¨‹ã€‚
    åªè¿”å›æ•°å­—ç­”æ¡ˆï¼Œå¦‚æœæ‰¾ä¸åˆ°ç›¸å…³ä¿¡æ¯ï¼Œè¯·å›ç­”"0"ã€‚"""
        
        else:
            return base_prompt + f"è¯·åœ¨æ•°æ®ä¸­æŸ¥æ‰¾ {metric_name} ç›¸å…³ä¿¡æ¯å¹¶ç»Ÿè®¡æ•°é‡ã€‚åªè¿”å›æ•°å­—ç­”æ¡ˆã€‚å¦‚æœæ‰¾ä¸åˆ°ï¼Œè¯·å›ç­”'0'ã€‚"
    
    def _process_single_question(self, messages, question_text, metric_name):
        """å¤„ç†å•ä¸ªé—®é¢˜"""
        print(f"  å¤„ç†é—®é¢˜: {question_text}")
        
        current_messages = messages.copy()
        question_prompt = self._get_question_prompt(question_text, metric_name)
        current_messages.append({'role': 'user', 'content': question_prompt})
        
        # è·å–ç­”æ¡ˆ
        question_completion = self.client.chat.completions.create(
            model=self.model_name,
            messages=current_messages,
            stream=True,
            stream_options={"include_usage": True}
        )
        
        # æ”¶é›†å›ç­”
        ai_response = ""
        for chunk in question_completion:
            if chunk.choices and len(chunk.choices) > 0 and chunk.choices[0].delta and chunk.choices[0].delta.content:
                ai_response += chunk.choices[0].delta.content
        
        ai_response = ai_response.strip()
        print(f"    LLMå›ç­”: {ai_response}")
        
        # è§£æç­”æ¡ˆ
        return self._parse_answer(ai_response, metric_name)
    
    def _parse_answer(self, ai_response, metric_name):
        """è§£æAIå›ç­”ï¼Œé’ˆå¯¹æŒ‡æ ‡ä¼˜åŒ–"""
        # æŸ¥æ‰¾æ•°å­—
        numbers = re.findall(r'\d+', ai_response)
        if numbers:
            # å¯¹äºæŸäº›æŒ‡æ ‡ï¼Œå¯èƒ½éœ€è¦ç‰¹æ®Šå¤„ç†
            if metric_name in ['ESIå‰1%å­¦ç§‘æ•°é‡', 'ESIå‰1â€°å­¦ç§‘æ•°é‡']:
                # ESIæŒ‡æ ‡é€šå¸¸æ•°é‡ä¸ä¼šå¤ªå¤§ï¼Œé€‰æ‹©æœ€å°çš„åˆç†æ•°å­—
                valid_numbers = [int(n) for n in numbers if int(n) <= 50]  # ESIå­¦ç§‘æ•°ä¸€èˆ¬ä¸è¶…è¿‡50
                if valid_numbers:
                    return str(min(valid_numbers))
            elif metric_name == 'æ•™è‚²éƒ¨è¯„ä¼°Aç±»å­¦ç§‘æ•°é‡':
                # æ•™è‚²éƒ¨è¯„ä¼°Aç±»å­¦ç§‘æ•°é‡é€šå¸¸ä¸ä¼šå¤ªå¤§ï¼Œä¸€èˆ¬ä¸è¶…è¿‡30ä¸ª
                valid_numbers = [int(n) for n in numbers if int(n) <= 30]
                if valid_numbers:
                    return str(min(valid_numbers))
            # ğŸ”¥ æ–°å¢è½¯ç§‘æŒ‡æ ‡çš„ç‰¹æ®Šå¤„ç† ğŸ”¥
            elif metric_name == 'è½¯ç§‘ä¸­å›½æœ€å¥½å­¦ç§‘æ’åå‰10%å­¦ç§‘æ•°é‡':
                # è½¯ç§‘å‰10%å­¦ç§‘æ•°é‡é€šå¸¸ä¸ä¼šå¤ªå¤§ï¼Œä¸€èˆ¬ä¸è¶…è¿‡40ä¸ª
                valid_numbers = [int(n) for n in numbers if int(n) <= 40]
                if valid_numbers:
                    return str(min(valid_numbers))
            # ğŸ”¥ æ–°å¢ä¸“ä¸šç›¸å…³æŒ‡æ ‡çš„ç‰¹æ®Šå¤„ç† ğŸ”¥
            elif metric_name == 'æœ¬ç§‘ä¸“ä¸šæ€»æ•°':
                # æœ¬ç§‘ä¸“ä¸šæ€»æ•°é€šå¸¸åœ¨20-200ä¹‹é—´
                valid_numbers = [int(n) for n in numbers if 5 <= int(n) <= 300]
                if valid_numbers:
                    return str(max(valid_numbers))  # ä¸“ä¸šæ€»æ•°å–è¾ƒå¤§å€¼æ›´åˆç†
            elif metric_name in ['å›½å®¶çº§ä¸€æµæœ¬ç§‘ä¸“ä¸šå»ºè®¾ç‚¹', 'çœçº§ä¸€æµæœ¬ç§‘ä¸“ä¸šå»ºè®¾ç‚¹']:
                # ä¸€æµä¸“ä¸šå»ºè®¾ç‚¹æ•°é‡é€šå¸¸ä¸ä¼šå¤ªå¤§
                valid_numbers = [int(n) for n in numbers if int(n) <= 100]
                if valid_numbers:
                    return str(min(valid_numbers))
            # ğŸ”¥ æ–°å¢æ•™å­¦ç›¸å…³æŒ‡æ ‡çš„ç‰¹æ®Šå¤„ç† ğŸ”¥
            elif metric_name in ['å›½å®¶çº§æ•™å­¦æˆæœå¥–', 'çœçº§æ•™å­¦æˆæœå¥–']:
                # æ•™å­¦æˆæœå¥–æ•°é‡é€šå¸¸è¾ƒå°‘
                valid_numbers = [int(n) for n in numbers if int(n) <= 50]
                if valid_numbers:
                    return str(min(valid_numbers))
            elif metric_name == 'å…¨å›½é«˜æ ¡é’å¹´æ•™å¸ˆæ•™å­¦ç«èµ›':
                # é’å¹´æ•™å¸ˆæ•™å­¦ç«èµ›è·å¥–æ•°é‡é€šå¸¸è¾ƒå°‘
                valid_numbers = [int(n) for n in numbers if int(n) <= 30]
                if valid_numbers:
                    return str(min(valid_numbers))
            elif metric_name in ['å›½å®¶çº§ä¸€æµæœ¬ç§‘è¯¾ç¨‹', 'çœçº§ä¸€æµæœ¬ç§‘è¯¾ç¨‹']:
                # ä¸€æµè¯¾ç¨‹æ•°é‡å¯èƒ½è¾ƒå¤š
                valid_numbers = [int(n) for n in numbers if int(n) <= 200]
                if valid_numbers:
                    return str(min(valid_numbers))
            elif metric_name in ['å›½å®¶çº§é«˜ç­‰æ•™è‚²æ™ºæ…§å¹³å°è¯¾ç¨‹', 'çœçº§é«˜ç­‰æ•™è‚²æ™ºæ…§å¹³å°è¯¾ç¨‹']:
                # æ™ºæ…§å¹³å°è¯¾ç¨‹æ•°é‡å¯èƒ½è¾ƒå¤š
                valid_numbers = [int(n) for n in numbers if int(n) <= 500]
                if valid_numbers:
                    return str(min(valid_numbers))
                # ğŸ”¥ æ–°å¢å­¦ä½ç‚¹æŒ‡æ ‡çš„ç‰¹æ®Šå¤„ç† ğŸ”¥
            elif metric_name in ['å­¦æœ¯å‹ç¡•å£«å­¦ä½ç‚¹', 'ä¸“ä¸šå‹ç¡•å£«å­¦ä½ç‚¹']:
                # ç¡•å£«å­¦ä½ç‚¹æ•°é‡é€šå¸¸åœ¨0-50ä¹‹é—´
                valid_numbers = [int(n) for n in numbers if int(n) <= 50]
                if valid_numbers:
                    return str(min(valid_numbers))
            elif metric_name in ['å­¦æœ¯å‹åšå£«å­¦ä½ç‚¹', 'ä¸“ä¸šå‹åšå£«å­¦ä½ç‚¹']:
                # åšå£«å­¦ä½ç‚¹æ•°é‡é€šå¸¸åœ¨0-30ä¹‹é—´ï¼ˆåšå£«ç‚¹ç›¸å¯¹è¾ƒå°‘ï¼‰
                valid_numbers = [int(n) for n in numbers if int(n) <= 30]
                if valid_numbers:
                    return str(min(valid_numbers))
            
            return numbers[0]
        
        # æ£€æŸ¥æ˜¯å¦æ˜ç¡®è¯´æ˜æœªæ‰¾åˆ°æˆ–ä¸º0
        if any(keyword in ai_response for keyword in ["æœªæ‰¾åˆ°", "æ— æ³•æ‰¾åˆ°", "æ²¡æœ‰æ‰¾åˆ°", "ä¸å­˜åœ¨", "ä¸º0", "æ˜¯0", "ç­‰äº0"]):
            return "0"
        
        # é»˜è®¤æƒ…å†µ
        print(f"    è­¦å‘Š: æ— æ³•ä»å›ç­” '{ai_response}' ä¸­æå–æ•°å­—ï¼Œæ ‡è®°ä¸º0")
        return "0"